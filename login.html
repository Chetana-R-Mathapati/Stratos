<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Stratos</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  
  <script src="js/firebase-config.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #f06, #4a90e2);
      font-family: 'Roboto', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .login-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 40px 50px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
      animation: slideIn 0.8s ease-out;
    }
    h2 {
      text-align: center;
      font-family: 'Open Sans', sans-serif;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }
    .input-group {
      margin-bottom: 25px;
      position: relative;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      color: #333;
      background-color: #f9f9f9;
      transition: all 0.3s ease;
    }
    .input-group input:focus, .input-group select:focus {
      border-color: #4a90e2;
      outline: none;
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }
    .input-group label {
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
      display: block;
      font-weight: 500;
    }
    .input-group .toggle-password {
      position: absolute;
      right: 15px;
      top: 42px;
      cursor: pointer;
      color: #666;
    }
    .input-group.error input {
      border-color: #dc3545;
    }
    .input-group.success input {
      border-color: #28a745;
    }
    .error-message {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    .remember-forgot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .remember-me {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
    }
    .forgot-password {
      color: #4a90e2;
      text-decoration: none;
      font-weight: 500;
    }
    .forgot-password:hover {
      text-decoration: underline;
    }
    .login-btn {
      width: 100%;
      padding: 14px;
      background: #4a90e2;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .login-btn:hover {
      background: #357abd;
      transform: translateY(-1px);
    }
    .login-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .signup-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #666;
    }
    .signup-link a {
      color: #4a90e2;
      text-decoration: none;
      font-weight: 500;
    }
    .signup-link a:hover {
      text-decoration: underline;
    }
    .login-status {
      text-align: center;
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .login-status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .login-status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    @keyframes slideIn {
      0% {
        opacity: 0;
        transform: translateY(-50px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <h2>Welcome Back</h2>
    <div id="loginStatus" class="login-status"></div>
    <form id="loginForm" novalidate>
      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>
        <div class="error-message" id="emailError"></div>
      </div>

      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required>
        <i class="toggle-password fas fa-eye" id="togglePassword"></i>
        <div class="error-message" id="passwordError"></div>
      </div>

      <div class="input-group">
        <label for="role">Role</label>
        <select id="role" name="role" required>
          <option value="">Select a role</option>
          <option value="user">User</option>
          <option value="mentor">Mentor</option>
          <option value="investor">Investor</option>
        </select>
        <div class="error-message" id="roleError"></div>
      </div>

      <div class="remember-forgot">
        <label class="remember-me">
          <input type="checkbox" name="rememberMe" id="rememberMe">
          Remember Me
        </label>
        <a href="forgot-password.html" class="forgot-password">Forgot Password?</a>
      </div>

      <button type="submit" class="login-btn">Login</button>
    </form>

    <div class="signup-link">
      Don't have an account? <a href="signin.html">Sign up</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('loginForm');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const roleSelect = document.getElementById('role');
      const loginStatus = document.getElementById('loginStatus');
      const rememberMeCheckbox = document.getElementById('rememberMe');
      const togglePassword = document.getElementById('togglePassword');

      // Load saved credentials if available
      const savedUser = JSON.parse(localStorage.getItem('savedUser'));
      if (savedUser) {
        emailInput.value = savedUser.email || '';
        roleSelect.value = savedUser.role || '';
        rememberMeCheckbox.checked = true;
      }

      // Password visibility toggle
      togglePassword.addEventListener('click', function() {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
      });

      // Show status message
      function showStatus(message, isError = false) {
        loginStatus.textContent = message;
        loginStatus.className = `login-status ${isError ? 'error' : 'success'}`;
        loginStatus.style.display = 'block';
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault();

        try {
          // Get stored users
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const user = users.find(u => u.email === emailInput.value.trim() && u.role === roleSelect.value);

          if (!user) {
            showStatus('Invalid email or role', true);
            return;
          }

          if (!user.verified) {
            showStatus('Please verify your email before logging in', true);
            return;
          }

          if (user.password !== passwordInput.value) {
            showStatus('Invalid password', true);
            return;
          }

          // Store user info in localStorage
          const userData = {
            fullName: user.fullName,
            email: user.email,
            role: user.role,
            lastLogin: new Date().toISOString()
          };
          
          localStorage.setItem('user', JSON.stringify(userData));
          localStorage.setItem('userLoggedIn', 'true');

          // Save credentials if remember me is checked
          if (rememberMeCheckbox.checked) {
            localStorage.setItem('savedUser', JSON.stringify(userData));
          } else {
            localStorage.removeItem('savedUser');
          }

          showStatus('Login successful! Redirecting...', false);

          // Check for redirect URL from session storage
          const redirectUrl = sessionStorage.getItem('redirectUrl');
          sessionStorage.removeItem('redirectUrl');

          // Redirect based on role after a short delay
          setTimeout(() => {
            if (redirectUrl) {
              window.location.href = redirectUrl;
            } else {
              window.location.href = user.role === 'mentor' ? 'mentor.html' :
                                     user.role === 'investor' ? 'funds.html' : 
                                     'index.html';
            }
          }, 1500);

        } catch (error) {
          console.error('Login error:', error);
          showStatus('An error occurred during login. Please try again.', true);
        }
      });

      // Check if user is already logged in
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          // User is signed in, redirect to dashboard
          window.location.href = 'dashboard.html';
        }
      });
    });
  </script>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const rememberMeCheckbox = document.getElementById("rememberMe");
    const statusMessage = document.getElementById("statusMessage");

    function showStatus(message, isError) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${isError ? 'error' : 'success'}`;
      statusMessage.style.display = 'block';
    }

    // Check for saved credentials and pre-fill
    const savedUser = JSON.parse(localStorage.getItem('savedUser') || 'null');
    if (savedUser) {
      usernameInput.value = savedUser.username;
      // passwordInput.value = savedUser.password; // Do NOT pre-fill password for security
      rememberMeCheckbox.checked = true;
    }

    loginForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();

      // --- Client-Side Admin Login Check (INSECURE for production) ---
      const ADMIN_USERNAME = "Chetana";
      const ADMIN_PASSWORD = "Chet@2004";

      if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        // Store a flag in localStorage for admin status (client-side only)
        localStorage.setItem('isAdmin', 'true');
        localStorage.setItem('userLoggedIn', 'true'); // Also set general login status
        localStorage.setItem('user', JSON.stringify({ username: ADMIN_USERNAME, role: 'admin' })); // Store user info

        showStatus('Admin login successful! Redirecting to admin panel...', false);
        setTimeout(() => {
          window.location.href = 'admin.html'; // Redirect to your admin page
        }, 1500);
        return; // Stop further processing for admin login
      }
      // --- END Client-Side Admin Login Check ---

      try {
        // Proceed with Firebase authentication for regular users
        const userCredential = await firebase.auth().signInWithEmailAndPassword(username, password);
        const user = userCredential.user;

        // Fetch user role from Firestore (assuming you've implemented this as suggested previously)
        const userDocRef = db.collection('users').doc(user.uid);
        const userDoc = await userDocRef.get();
        const userData = userDoc.exists ? userDoc.data() : { email: user.email, role: 'user' }; // Default to 'user' if role not found

        localStorage.setItem('user', JSON.stringify(userData));
        localStorage.setItem('userLoggedIn', 'true');
        localStorage.removeItem('isAdmin'); // Ensure admin flag is removed for non-admin users

        // Save credentials if remember me is checked
        if (rememberMeCheckbox.checked) {
          localStorage.setItem('savedUser', JSON.stringify({ username: username }));
        } else {
          localStorage.removeItem('savedUser');
        }

        showStatus('Login successful! Redirecting...', false);

        const redirectUrl = sessionStorage.getItem('redirectUrl');
        sessionStorage.removeItem('redirectUrl');

        setTimeout(() => {
          if (redirectUrl) {
            window.location.href = redirectUrl;
          } else {
            // Redirect based on role fetched from Firebase/Firestore or default
            if (userData.role === 'mentor') {
              window.location.href = 'mentor.html';
            } else if (userData.role === 'investor') {
              window.location.href = 'funds.html';
            } else {
              window.location.href = 'index.html'; // Default redirect for other roles or general users
            }
          }
        }, 1500);

      } catch (error) {
        console.error('Login error:', error);
        showStatus('An error occurred during login. Please try again. ' + error.message, true);
      }
    });

    // Check if user is already logged in (including admin)
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        // If an admin has logged in via the hardcoded check, redirect them
        if (localStorage.getItem('isAdmin') === 'true') {
            window.location.href = 'admin.html';
        } else {
            // For regular Firebase authenticated users, fetch their role and redirect
            // Ensure db is initialized (from firebase-config.js)
            if (typeof db !== 'undefined') {
                db.collection('users').doc(user.uid).get().then(doc => {
                    const userData = doc.exists ? doc.data() : { email: user.email, role: 'user' };
                    if (userData.role === 'mentor') {
                        window.location.href = 'mentor.html';
                    } else if (userData.role === 'investor') {
                        window.location.href = 'funds.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }).catch(error => {
                    console.error("Error fetching user role:", error);
                    window.location.href = 'index.html'; // Fallback
                });
            } else {
                console.warn("Firestore 'db' not initialized. Ensure firebase-config.js is correct.");
                window.location.href = 'index.html'; // Fallback
            }
        }
      }
    });
  });
</script>
</body>
</html>